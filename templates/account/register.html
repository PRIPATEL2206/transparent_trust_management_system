{% extends "base.html" %}

{% block content %}

<div class="flex-grow flex items-center justify-center px-4 py-12">
  <div class="bg-white shadow-xl rounded-2xl w-full max-w-3xl p-8">

    <!-- Progress Bar -->
    <div class="flex items-center justify-between mb-10">
      <div class="step active">1</div>
      <div class="line"></div>
      <div class="step">2</div>
      <div class="line"></div>
      <div class="step">3</div>
      <div class="line"></div>
      <!-- <div class="step">4</div>
      <div class="line"></div> -->
      <div class="step">4</div>
    </div>

    <form id="registerForm" method="post" action="{% url 'register' %}" novalidate>
      {% csrf_token %}
      <!-- ================= SECTION 1 ================= -->
      <div class="section">
        <h2 class="section-title">Basic Identity</h2>

        <div class="input-group mb-4">
          <input class="input mandatory name-field" placeholder="First Name" name="firstname">
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Only alphabets allowed</p>
        </div>

        <div class="input-group mb-4">
          <input class="input mandatory name-field" placeholder="Last Name" name="lastname">
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Only alphabets allowed</p>
        </div>
        <div class="input-group mb-4">
          <input class="input mandatory name-field" placeholder="Middle Name" name="middelname">
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Only alphabets allowed</p>
        </div>

        <div class="input-group mb-4">
          <input class="input mandatory email-field" placeholder="Email Address" name="email">
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Invalid email format</p>
        </div>

        <div class="input-group mb-4">
          <div class="flex gap-3">
            <select id="phoneCountry" class="input w-1/3" name="stdcode">
              <option value="IN">ðŸ‡®ðŸ‡³ +91</option>
              <option value="US">ðŸ‡ºðŸ‡¸ +1</option>
            </select>
            <input class="input mandatory phone-field w-2/3" placeholder="Mobile Number" name="phone">
          </div>
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Invalid phone number</p>
        </div>
      </div>

      <!-- ================= SECTION 2 ================= -->
      <div class="section hidden">
        <h2 class="section-title">Account Security</h2>

        <div class="input-group mb-4">
          <input id="password" type="password" class="input mandatory" placeholder="Password" name="password1">
          <p class="error invalid-error">
            8â€“12 chars, 1 uppercase, 1 special character, no spaces
          </p>
        </div>

        <div class="input-group mb-4">
          <input id="confirmPassword" type="password" class="input mandatory" placeholder="Confirm Password" name="password2">
          <p class="error invalid-error">Passwords do not match</p>
        </div>
      </div>

      <!-- ================= SECTION 3 ================= -->
      <div class="section hidden">
        <h2 class="section-title">Address Information</h2>

        <div class="input-group mb-4">
          <input class="input mandatory" placeholder="Address Line 1" name="address1">
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <input class="input" placeholder="Address Line 2 (Optional)" name="address2">
        </div>

        <div class="input-group mb-4">
          <input class="input mandatory" placeholder="City" name="city">
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <select id="country" class="input mandatory" name="country">
            <option value="">Select Country</option>
            <option value="IN">India</option>
            <option value="US">United States</option>
          </select>
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <select id="state" class="input mandatory" name="state">
            <option value="">Select State</option>
            <option value="gujarat">Gujarat</option>
            <option value="maharashtra">Maharashtra</option>
            <option value="rajasthan">Rajasthan</option>
          </select>
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <input id="zip" class="input mandatory pincode-field" placeholder="ZIP / Pincode" name="zipcode">
          <p class="error empty-error">This field is mandatory</p>
          <p class="error invalid-error">Invalid ZIP / Pincode</p>
        </div>
      </div>

      <!-- ================= SECTION 4 ================= -->
      <!-- <div class="section hidden">
        <h2 class="section-title">Trust Relationship</h2>

        <div class="input-group mb-4">
          <select class="input mandatory">
            <option value="">Registering As</option>
            <option>User</option>
            <option>Trust Member</option>
          </select>
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <input class="input" placeholder="Referral Code (Optional)">
        </div>

        <div class="input-group mb-4">
          <textarea class="input" placeholder="Reason to Join (Optional)"></textarea>
        </div>
      </div> -->

      <!-- ================= SECTION 5 ================= -->
      <div class="section hidden">
        <h2 class="section-title">Terms & Consent</h2>

        <div class="input-group mb-4">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="mandatory" name="accepted1">
            <label>Accept Terms & Conditions</label>
          </div>
          <p class="error empty-error">This field is mandatory</p>
        </div>

        <div class="input-group mb-4">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="mandatory" name="accepted2">
            <label>Accept Privacy Policy</label>
          </div>
          <p class="error empty-error">This field is mandatory</p>
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex justify-between mt-10">
        <button type="button" id="prevBtn" class="btn-secondary hidden">Previous</button>
        <button type="button" id="nextBtn" class="btn-primary">Next</button>
      </div>

    </form>
  </div>
</div>



<!-- ================= STYLES ================= -->
<style>
  .step {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 2px solid #0f766e;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #0f766e
  }

  .step.active {
    background: #0f766e;
    color: #fff
  }

  .line {
    flex: 1;
    height: 2px;
    background: #99f6e4
  }

  .section-title {
    text-align: center;
    font-size: 1.6rem;
    font-weight: 700;
    color: #0f766e;
    margin-bottom: 1.5rem
  }

  .input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 8px
  }

  .error {
    display: none;
    color: red;
    font-size: .85rem;
    margin-top: 4px
  }

  .btn-primary {
    background: #0f766e;
    color: #fff;
    padding: 10px 28px;
    border-radius: 8px
  }

  .btn-secondary {
    border: 1px solid #0f766e;
    color: #0f766e;
    padding: 10px 28px;
    border-radius: 8px
  }
</style>

{% endblock content %}
{% block script %}
<!-- ================= SCRIPT ================= -->
<script>
  const sections = document.querySelectorAll('.section');
  const steps = document.querySelectorAll('.step');
  let current = 0;

  const nameRx = /^[A-Za-z]+$/;
  const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const passRx = /^(?=.*[A-Z])(?=.*[!@#$%^&*])\S{8,12}$/;
  const phoneRules = { IN: 10, US: 10 };
  const zipRules = { IN: /^\d{6}$/, US: /^\d{5}$/ };
  const states = { IN: ["Gujarat", "Maharashtra", "Rajasthan"], US: ["California", "Texas", "New York"] };

  function showSection(i) {
    sections.forEach(s => s.classList.add('hidden'));
    sections[i].classList.remove('hidden');
    steps.forEach((s, idx) => s.classList.toggle('active', idx <= i));
    prevBtn.classList.toggle('hidden', i === 0);
    nextBtn.textContent = i === sections.length - 1 ? 'Submit' : 'Next';
  }

  function showError(input, type) {
    const g = input.closest('.input-group');
    if (!g) return;
    g.querySelectorAll('.error').forEach(e => e.style.display = 'none');
    g.querySelector(`.${type}-error`)?.style.setProperty('display', 'block');
  }

  function clearError(input) {
    const g = input.closest('.input-group');
    if (!g) return;
    g.querySelectorAll('.error').forEach(e => e.style.display = 'none');
  }

  function validateInput(input) {
    if (input.type === 'checkbox') {
      if (!input.checked) { showError(input, 'empty'); return false; }
      clearError(input); return true;
    }

    const v = input.value.trim();
    if (!v) { showError(input, 'empty'); return false; }

    if (input.classList.contains('name-field') && !nameRx.test(v)) { showError(input, 'invalid'); return false; }
    if (input.classList.contains('email-field') && !emailRx.test(v)) { showError(input, 'invalid'); return false; }
    if (input.classList.contains('phone-field') && v.length !== phoneRules[phoneCountry.value]) { showError(input, 'invalid'); return false; }
    if (input.id === 'password' && !passRx.test(v)) { showError(input, 'invalid'); return false; }
    if (input.id === 'confirmPassword' && v !== password.value) { showError(input, 'invalid'); return false; }
    if (input.classList.contains('pincode-field') && !zipRules[country.value]?.test(v)) { showError(input, 'invalid'); return false; }

    clearError(input); return true;
  }

  document.querySelectorAll('.mandatory').forEach(i => {
    i.addEventListener('input', () => validateInput(i));
    i.addEventListener('blur', () => validateInput(i));
  });

  country.addEventListener('change', () => {
    state.innerHTML = '<option value="">Select State</option>';
    states[country.value]?.forEach(s => state.innerHTML += `<option>${s}</option>`);
  });

  nextBtn.onclick = () => {
    let valid = true;
    sections[current].querySelectorAll('.mandatory').forEach(i => {
      if (!validateInput(i)) valid = false;
    });
    if (!valid) return;
    if (current < sections.length - 1) { current++; showSection(current); }
    else registerForm.submit();
  };

  prevBtn.onclick = () => { current--; showSection(current); }
  showSection(current);
</script>

{% endblock script %}