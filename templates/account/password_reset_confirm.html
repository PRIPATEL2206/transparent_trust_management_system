{% extends "base.html" %}

{% block title %}Reset Password {% endblock title %}

{% block content %}
<div class="flex-grow flex items-center justify-center px-4">
    <div class="bg-white shadow-lg rounded-lg p-8 max-w-md w-full">

        <h2 class="text-2xl font-semibold text-teal-800 mb-6 text-center">
            Reset Your Password
        </h2>

        <form method="post" id="passwordResetForm" class="space-y-4">
            {% csrf_token %}

            <!-- New Password -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    New Password
                </label>
                <input
                    type="password"
                    name="new_password1"
                    id="new_password1"
                    autocomplete="new-password"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                >

                <!-- Realtime error -->
                <p id="password1Error" class="text-red-500 text-sm mt-1 hidden"></p>

                <!-- Django error fallback -->
                {% if form.new_password1.errors %}
                    <p class="text-red-500 text-sm mt-1">
                        {{ form.new_password1.errors|striptags }}
                    </p>
                {% endif %}
            </div>

            <!-- Confirm Password -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    Confirm New Password
                </label>
                <input
                    type="password"
                    name="new_password2"
                    id="new_password2"
                    autocomplete="new-password"
                    class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                >

                <!-- Realtime error -->
                <p id="password2Error" class="text-red-500 text-sm mt-1 hidden"></p>

                <!-- Django error fallback -->
                {% if form.new_password2.errors %}
                    <p class="text-red-500 text-sm mt-1">
                        {{ form.new_password2.errors|striptags }}
                    </p>
                {% endif %}
            </div>

            <button
                type="submit"
                id="submitBtn"
                class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 transition disabled:opacity-50"
                disabled
            >
                Reset Password
            </button>
        </form>

    </div>
</div>

{% endblock content %}
{% block script %}

<script>
const password1 = document.getElementById("new_password1");
const password2 = document.getElementById("new_password2");
const password1Error = document.getElementById("password1Error");
const password2Error = document.getElementById("password2Error");
const submitBtn = document.getElementById("submitBtn");

function validatePasswordRules(password) {
    const errors = [];

    if (password.length < 8) {
        errors.push("Must be at least 8 characters long.");
    }
    if (!/[A-Z]/.test(password)) {
        errors.push("Must contain at least one uppercase letter.");
    }
    if (!/[a-z]/.test(password)) {
        errors.push("Must contain at least one lowercase letter.");
    }
    if (!/[0-9]/.test(password)) {
        errors.push("Must contain at least one number.");
    }

    return errors;
}

function validateForm() {
    const pwd1 = password1.value;
    const pwd2 = password2.value;

    let valid = true;

    // Validate password rules
    const pwdErrors = validatePasswordRules(pwd1);
    if (pwdErrors.length > 0) {
        password1Error.textContent = pwdErrors.join(" ");
        password1Error.classList.remove("hidden");
        valid = false;
    } else {
        password1Error.classList.add("hidden");
    }

    // Validate match
    if (pwd2 && pwd1 !== pwd2) {
        password2Error.textContent = "Passwords do not match.";
        password2Error.classList.remove("hidden");
        valid = false;
    } else {
        password2Error.classList.add("hidden");
    }

    submitBtn.disabled = !valid;
}

password1.addEventListener("input", validateForm);
password2.addEventListener("input", validateForm);
</script>
{% endblock script %}