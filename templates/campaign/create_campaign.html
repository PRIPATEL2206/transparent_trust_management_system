{% extends 'base.html' %}

{% block content %}
  <div class="flex justify-center px-4 py-10">
    <div class="w-full max-w-3xl bg-white shadow-lg rounded-xl p-8">
      <!-- Title -->
      <h2 class="text-2xl font-bold text-teal-800 text-center mb-8">Create Campaign</h2>

      <form method="post" enctype="multipart/form-data" id="campaignForm" class="space-y-6">
        {% csrf_token %}

        <!-- Title -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Title *</label>
          <input type="text" name="title" required placeholder="Enter campaign title" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
          {% if form.title.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.title.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Slug (Optional) -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Slug (optional)</label>
          <input type="text" name="slug" placeholder="Leave blank to auto-generate" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          <p class="text-sm text-gray-500 mt-1">If left blank, it will be generated from the title.</p>
        </div>

        <!-- Short Description -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Short Description *</label>
          <textarea name="short_description" rows="3" required placeholder="Brief summary of the campaign (max 500 characters)" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
          {% if form.short_description.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.short_description.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Description -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Description *</label>
          <textarea name="description" rows="6" required placeholder="Detailed description of the campaign" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500"></textarea>
          {% if form.description.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.description.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Category -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Category *</label>
          <select name="category" required class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500">
            <option value="">---------</option>
            <option value="1">ca</option>
          </select>
          {% if form.category.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.category.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Tags -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Tags *</label>
          <input type="text" name="tags" required placeholder="health, education, women" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
        </div>

        <!-- Cover Image -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Cover Image *</label>
          <input type="file" name="cover_image" accept="image/*" required class="w-full border rounded-lg px-3 py-2" />
        </div>

        <!-- Dates -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-teal-800 font-medium mb-1">Start Date & Time *</label>
            <input type="datetime-local" name="start_date" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          </div>

          <div>
            <label class="block text-teal-800 font-medium mb-1">End Date & Time *</label>
            <input type="datetime-local" name="end_date" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          </div>
        </div>

        <!-- Timezone -->
        <!-- Timezone (UNCHANGED VALUES) -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Timezone *</label>
          <select name="timezone_name" required class="w-full px-4 py-2 border rounded-lg bg-white focus:ring-2 focus:ring-teal-500">
            <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
            <option value="UTC">UTC</option>
            <option value="Asia/Dubai">Asia/Dubai</option>
            <option value="Europe/London">Europe/London</option>
            <option value="America/New_York">America/New_York</option>
          </select>
          {% if form.timezone_name.errors %}
            <p class="text-red-500 text-sm mt-1">{{ form.timezone_name.errors|striptags }}</p>
          {% endif %}
        </div>

        <!-- Donation Amounts -->
        <div class="grid md:grid-cols-3 gap-6">
          <div>
            <label class="block text-teal-800 font-medium mb-1">Goal Amount *</label>
            <input type="number" step="0.01" min="0" name="goal_amount" required placeholder="Total target amount" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          </div>

          <div>
            <label class="block text-teal-800 font-medium mb-1">Minimum Donation *</label>
            <input type="number" step="0.01" min="0" name="minimum_donation_amount" required placeholder="Minimum allowed" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          </div>

          <div>
            <label class="block text-teal-800 font-medium mb-1">Maximum Donation *</label>
            <input type="number" step="0.01" min="0" name="maximum_donation_amount" required placeholder="Maximum allowed" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500" />
          </div>
        </div>

        <!-- Gallery -->
        <div>
          <label class="block text-teal-800 font-medium mb-1">Gallery Images *</label>
          <input type="file" name="gallery_bulk" multiple required class="w-full border rounded-lg px-3 py-2" />
        </div>

        <!-- Submit -->
        <div class="text-center pt-6">
          <button type="submit" class="bg-teal-600 text-white px-10 py-3 rounded-lg hover:bg-teal-700 transition font-medium">Create Campaign</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {

  const startDate = document.querySelector('[name="start_date"]');
  const endDate = document.querySelector('[name="end_date"]');
  const minAmount = document.querySelector('[name="minimum_donation_amount"]');
  const maxAmount = document.querySelector('[name="maximum_donation_amount"]');
  const form = document.getElementById("campaignForm");

  /* ---------- Helper: error message ---------- */
  function showError(input, message) {
    let error = input.parentElement.querySelector(".js-error");
    if (!error) {
      error = document.createElement("p");
      error.className = "js-error text-red-500 text-sm mt-1";
      input.parentElement.appendChild(error);
    }
    error.innerText = message;
  }

  function clearError(input) {
    const error = input.parentElement.querySelector(".js-error");
    if (error) error.remove();
  }

  /* ---------- DATE VALIDATION ---------- */

  // End date disabled initially
  endDate.disabled = true;

  // Set min start date = today
  const now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  const todayISO = now.toISOString().slice(0, 16);
  startDate.min = todayISO;

  startDate.addEventListener("input", function () {
    clearError(startDate);

    if (!this.value) {
      endDate.disabled = true;
      endDate.value = "";
      return;
    }

    // Enable end date immediately
    endDate.disabled = false;
    endDate.min = this.value;

    if (new Date(this.value) < new Date(todayISO)) {
      showError(startDate, "Start date cannot be earlier than today.");
    }
  });

  endDate.addEventListener("input", function () {
    clearError(endDate);

    if (!startDate.value) {
      showError(endDate, "Please select a start date first.");
      return;
    }

    if (new Date(this.value) < new Date(startDate.value)) {
      showError(endDate, "End date must be after the start date.");
    }
  });

  /* ---------- AMOUNT VALIDATION ---------- */

  function validateAmounts() {
    clearError(minAmount);
    clearError(maxAmount);

    const minVal = parseFloat(minAmount.value);
    const maxVal = parseFloat(maxAmount.value);

    if (!isNaN(minVal) && !isNaN(maxVal) && maxVal < minVal) {
      showError(maxAmount, "Maximum amount cannot be less than minimum amount.");
    }
  }

  minAmount.addEventListener("input", validateAmounts);
  maxAmount.addEventListener("input", validateAmounts);

  /* ---------- FINAL SUBMIT CHECK ---------- */
  form.addEventListener("submit", function (e) {
    let hasError = false;

    // Date validation
    if (startDate.value && new Date(startDate.value) < new Date(todayISO)) {
      showError(startDate, "Start date cannot be earlier than today.");
      hasError = true;
    }

    if (startDate.value && endDate.value &&
        new Date(endDate.value) < new Date(startDate.value)) {
      showError(endDate, "End date must be after the start date.");
      hasError = true;
    }

    // Amount validation
    const minVal = parseFloat(minAmount.value);
    const maxVal = parseFloat(maxAmount.value);

    if (!isNaN(minVal) && !isNaN(maxVal) && maxVal < minVal) {
      showError(maxAmount, "Maximum amount cannot be less than minimum amount.");
      hasError = true;
    }

    if (hasError) {
      e.preventDefault();
    }
  });

});
</script>
{% endblock %}